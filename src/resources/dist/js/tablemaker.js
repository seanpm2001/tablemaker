!function($){Craft.TableMaker=Garnish.Base.extend({columnsTableId:null,rowsTableId:null,columnsTableName:null,rowsTableName:null,columnsTableInputPath:null,rowsTableInputPath:null,columns:null,rows:null,columnSettings:null,fieldId:null,columnsTable:null,rowsTable:null,$columnsTable:null,$rowsTable:null,$input:null,init:function(t,e,s,o,a,l,n,i){this.columnsTableId=e,this.rowsTableId=s,this.columnsTableName=o,this.rowsTableName=a,this.columnsTableInputPath=this.columnsTableName.replace(/]/g,"").split("["),this.rowsTableInputPath=this.rowsTableName.replace(/]/g,"").split("["),this.columns=l,this.rows=n,this.columnSettings=i,this.fieldId=t,this.$columnsTable=$("#"+this.columnsTableId),this.$rowsTable=$("#"+this.rowsTableId),this.$input=$("#"+t+"-field").find("input.table-maker-field"),this.initColumnsTable(),this.initRowsTable(),this.makeDataBlob()},onColumnsAddRow:function(){this.bindColumnsTableChanges(),this.reconstructRowsTable()},onRowsAddRow:function(){this.bindRowsTableTextChanges(),this.makeDataBlob()},bindColumnsTableChanges:function(){var t=this.columnsTable.$tbody.find("textarea");this.removeListener(t,"textchange"),this.addListener(t,"textchange",$.debounce(250,(function(t){this.reconstructRowsTable(t)})));var e=this.columnsTable.$tbody.find("select");this.removeListener(e,"change"),this.addListener(e,"change",$.debounce(250,(function(t){this.reconstructRowsTable(t)})))},bindRowsTableTextChanges:function(){var t=this.rowsTable.$tbody.find("textarea");this.removeListener(t,"textchange"),this.addListener(t,"textchange",$.debounce(250,(function(t){this.makeDataBlob(t)})))},initColumnsTable:function(){this.columnsTable=new Craft.EditableTable(this.columnsTableId,this.columnsTableName,this.columnSettings,{rowIdPrefix:"col",allowAdd:!0,allowDelete:!0,allowReorder:!0,onAddRow:$.proxy(this,"onColumnsAddRow"),onDeleteRow:$.proxy(this,"reconstructRowsTable")}),this.bindColumnsTableChanges(),this.columnsTable.sorter.settings.onSortChange=$.proxy(this,"reconstructRowsTable")},initRowsTable:function(t){this.rowsTable=new Craft.EditableTable(this.rowsTableId,this.rowsTableName,this.columns,{rowIdPrefix:"row",allowAdd:!0,allowDelete:!0,allowReorder:!0,onAddRow:$.proxy(this,"onRowsAddRow"),onDeleteRow:$.proxy(this,"makeDataBlob")}),this.bindRowsTableTextChanges(),this.rowsTable.sorter.settings.onSortChange=$.proxy(this,"makeDataBlob")},reconstructRowsTable:function(){this.getDataFromTables(),console.log("reconstructRowsTable");var t="<thead><tr>";for(var e in this.columns)this.columns[e].type="singleline",t+='<th scope="col" class="header">'+(this.columns[e].heading?this.columns[e].heading:"&nbsp;")+"</th>";t+='<th class="header" colspan="2"></th></tr></thead>';var s=$("<table/>",{id:this.rowsTableId,class:"editable fullwidth"}).append(t),o=$("<tbody/>").appendTo(s);for(var a in this.rows)this.rows.hasOwnProperty(a)&&Craft.EditableTable.createRow(a,this.columns,this.rowsTableName,this.rows[a]).appendTo(o);this.rowsTable.$table.replaceWith(s),this.rowsTable.destroy(),delete this.rowsTable,this.initRowsTable(this.columns),this.makeDataBlob()},getDataFromTables:function(){var t=Craft.expandPostArray(Garnish.getPostData(this.columnsTable.$tbody)),e=Craft.expandPostArray(Garnish.getPostData(this.rowsTable.$tbody));if(!$.isEmptyObject(t))for(var s=0;s<this.columnsTableInputPath.length;s++){var o;t=t[o=this.columnsTableInputPath[s]]}if(this.columns=t,!$.isEmptyObject(e))for(var s=0;s<this.rowsTableInputPath.length;s++){var o;e=e[o=this.rowsTableInputPath[s]]}this.rows=e},makeDataBlob:function(){this.getDataFromTables();var t={columns:this.columns,rows:this.rows};this.$input.val(JSON.stringify(t))}}),function(t,e){var $=t.jQuery||t.Cowboy||(t.Cowboy={}),s;$.throttle=s=function(t,s,o,a){function l(){function l(){i=+new Date,o.apply(h,b)}function r(){n=e}var h=this,u=+new Date-i,b=arguments;a&&!n&&l(),n&&clearTimeout(n),a===e&&u>t?l():!0!==s&&(n=setTimeout(a?r:l,a===e?t-u:t))}var n,i=0;return"boolean"!=typeof s&&(a=o,o=s,s=e),$.guid&&(l.guid=o.guid=o.guid||$.guid++),l},$.debounce=function(t,o,a){return a===e?s(t,o,!1):s(t,a,!1!==o)}}(this)}(jQuery);
//# sourceMappingURL=tablemaker.js.map